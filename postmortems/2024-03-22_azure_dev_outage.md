# 2024-03-22 Azure dev deployment week long outage

## What

The app registration secret in client's Azure deploy expired on 22 March 2024, which caused the authorisation flow for the App to be unable to access the Azure Active Directory to authenticate users, and meant that users were unable to access the platform. 

After we became aware the secret had expired, the secret was not able to be regenerated internally.  

Once the secret was regenerated by a third-party supplier, governance processes had to be followed to reinstate the secret. 


2024 (all times UTC)
* 2024/03/22 Friday 13:17 – app registration Secret expired 
* 2024/03/22 Friday 14:38 – First request to authorisation server with a denial; generated an Azure Monitor Alert sent to Support Inbox 
* 2024/03/25 Monday 10:38 – First Azure Monitor Alert forwarded to MP & AL (developers)
* 2024/03/25 Monday 13:29 Development Team Sprint Planning session begins; Product Owner (PO), QA, and all developers are among attendees – this is only relevant as an indication that the team were in a meeting 
* 2024/03/25 Monday 13:46 Internal user reports trying to access the site and being unable to log in 
* 2024/03/25 Monday 13:47 Confirmed that second internal user is also not able to log in 
* 2024/03/25 Monday 13:54 MP confirms that the app registration secret for the prod version of the app has expired and needs to be regenerated 
* 2024/03/25 Monday 13:57 MP discovers his account for client's Azure env is blocked 
* 2024/03/25 Monday 14:02 MP is reminded that the guest B2B account is unable to regenerate secrets, despite being an owner of the app registration for which the secret has expired
* 2024/03/25 Monday 15:04 Development Team Sprint Planning ends 
* 2024/03/25 Monday 15:19 MP calls IT Service Desk, account is blocked because it has expired and needs account extension from line manager for the password to be reset and the account reactivated. Expired due to original timing authorized for account.  
* 2024/03/25 Monday 15:48 Line manager who must request the account extension is identified (normal LM is on long term leave) 
* 2024/03/25 Monday 15:53 Notice added to client's Sharepoint indicating that app is down 
* 2024/03/25 Monday 17:41 Ticket is filed in client's IT support system with a request to make PO owner of App registration
* 2024/03/25 Monday 17:43 Ticket is filed in client's IT support system with a request to regenerate the secret
* 2024/03/25 Monday 16:14 Contacted line manager to request account extension 
* 2024/03/25 Monday 18:34 Messaged LM on long term leave on Teams to ask them to regenerate the secret.  
* 2024/03/26 Tuesday 09:30 Senior dev confirms no access to pipelines or repo on Azure Devops has been activated overnight 
* 2024/03/26 Tuesday 11:06 Emailed line manager re tickets. 
* 2024/03/26 Tuesday 13:12 internal user sent a Teams message in a chat with line manager, PO, and MP & AL with the list of concerns/tickets captured in emails and corresponding asks for support. 
* 2024/03/26 Tuesday 13:56 Email sent to top users to inform of the inability to log in. Sent per client standards of using all addressees in “To” field, but should have been in BCC field.  
* 2024/03/26 Tuesday 15:44 MP sent an email to individual at third party supplier to respond to questions raised (unclear to whom the questions were directed) about the ticket content and approval status 
* 2024/03/26 Tuesday 16:34 PO asked in the additional comments section of the ticket for an update on the ticket, along with a way to escalate the ticket and a recap of this issue.  
* 2024/03/26 Tuesday 16:38 PO sent a Teams message in a chat with line manager with an ask re escalation for the ticket.  
* 2024/03/26 Tuesday 17:29 PO calls IT service desk for update on both tickets. IT Service Desk escalates one as cybersecurity team needs to provide approval. IT Service Desk advises contact two individuals on cybersecurity team re the other ticket.  
* 2024/03/26 Tuesday 17:46 PO emails two individuals per advice of IT Service Desk 
* 2024/03/26 Tuesday 21:44 Line manager indicates a change request which goes through the Technical Review Board and Change Approval Board will be required to implement the change once the secret is received 
* 2024/03/26 Tuesday 22:51 Ticket re access is first round approved 
* 2024/03/27 Wednesday 08:20 MP receives the new secret details
* 2024/03/27 Wednesday 09:47 Ticket re access is second round approved 
* 2024/03/27 Wednesday 09:51 Remainder of team becomes aware of new secret details
* 2024/03/27 Wednesday 10:50 Other internal user speaks to line manager for approval to upload the new client secret – indicates we need authorisation not to go through a change request 
* 2024/03/27 Wednesday 11:53 MP confirms he has access to his client account again and is able to login 
* 2024/03/27 Wednesday 13:41 PO was successfully added as an owner to the app registration
* 2024/03/27 Wednesday 14:26 MP able to add PO as an owner to the DEV environment app registration 
* 2024/03/28 Thursday 13:30 Internal user and MP attended CAB and got approval to upload secret 
* 2024/03/28 Thursday 15:34 app is back online 


## Why

### Why were the Azure Monitor Alerts which should have indicated the problem not more quickly responded to? 

While we received a number of Azure Monitor Alerts to the Support inbox  – alerts are habitually received for a known issue related to the web service sending out a 500 error when a connection is dropped instead of handling it. We use async handling rather than having a public blob storage, which makes the server report an error when connection is dropped that it shouldn’t. The Azure Monitor Alerts received from Friday 22 March 2024 through to Monday 25 March 2024 before first internal user reported the issue were not properly examined as they were inappropriately assumed to have been caused by the known issue, rather than a new problem.  

In addition to this, the first alert was received at 14:38 on the Friday, but only forwarded to MP & AL at 10:38 on Monday.  

### Why was the secret allowed to expire? 

1. No system reminder to renew secret 
Azure does not automatically send any notifications for impending expiry of secret. There isn’t an obvious place for us to set these up for ourselves, but we have also never asked about it. We intend to look into some scripts that we could potentially run that would enable automated reminders for the secret expiry, but we also need to set up our own alerts and reminders for this, and it was not done for this secret.

2. No manual reminder from client to renew secret 
Third party supplier sends an excel spreadsheet monthly of Service Principal secrets expiring. The secret that expired was not listed in the spreadsheet that is sent monthly – 4 of our service principals are listed, but 4 of the other service principals for the app are not listed, and none of the app registrations are listed. The secret that expired and caused the lack of access was an app registration secret.  

3. Inconsistent expiry timelines 
Each of the different types of secrets have different expiry timelines, which makes tracking them harder. We can’t generically indicate that a year from now we need to redo this, so the dates need to be tracked separately and specifically rather than conceptually. Policy doc somewhere says things are supposed to expire 6 monthly, but most of the defaults have been set to annual expiry (e.g. cert is 3 months).  

It would be helpful to have these tracked in Jira and DevOps, as well as to potentially update all secrets early on the same day, so as to simply renew all of them on the shortest timeline that any one of them is required to be renewed.  

4. No internal reminder to renew secret 
This secret has previously expired, and caused the same issue. At that time, it was established that there is a need to create calendar invites for the expiry of secrets. There were no reminders recorded for this particular secret. While we have created calendar reminders for similar renewals for other secrets, this particular one was missed. Responsibility for creating this calendar invite was never specifically agreed, but three individuals have all created these invites – just not one for this particular secret.  

PO has subsequently created calendar invites for reminders when the two client secrets expire, and we are creating our own full list of all of the Service Principals and App Registrations and associated secret expiry dates so as to better track these. 

### Why was the secret not immediately regenerated? 
1. When we are unable to regenerate, getting client support to get it regenerated is unclear. 
In the event of an issue or unscheduled work, there is not a clear/formal escalation path for Azure tickets logged in client IT system. As we were unable to regenerate (explained below) it took some time for the ticket for the regeneration of the secret to be addressed.  

2. Neither of the owners are currently able to regenerate 
One account is a guest B2B account which has never had permissions to regenerate the secret. Other account is for LM currently on long term paternity leave. When LM went on paternity leave, no plan was made for who else would have the same permissions to regenerate secrets as he does.  

In addition, clients' Azure DevOps security permissions appear to have changed more broadly sometime after 6 September 2023 (the last traceable date where we can be absolutely certain MP & AL had access to the pieplines and repos on Azure Devops) without us being notified. MP & AL (again on B2B accounts) were either downgraded from being Basic users in devops down to merely Stakeholders, who cannot access the pipelines and repos, or the permissions for what Stakeholders can access was changed. Where pipelines and repos were previously visible to them in Azure Devops, they became not visible sometime after 6 September 2023. While not having directly contributed to the problem, this kind of practice could represent a risk. Subsequently, both senior developers’ B2B accounts have been upgraded to Basic Users and can now see and access Pipelines and Repos in DevOps. 

MP has both a B2B and non-B2B account – and the permissions for each are different. The Dev environment has all the necessary permissions for the non-B2B (client) account, as this environment was setup second. The primary Prod environment was setup before Martin had a non-B2B (client) account and was therefore setup with the B2B account.  

Subsequently, both of MP’s accounts (client and B2B) have been made Owners of the Prod app registration, as well as both of PO’s accounts. MP has added PO's NH account as an owner to the Dev app registration. We have also located all of the other app registrations and service principals and requested both MP and PO be added as owners to all of them.  

### Why wasn’t this noticed on the Azure Dashboard? 
Logging in to the client account, while also having a standard MS account for daily work as an employee has made logging into the dashboard as a regular habit less likely given the additional login required. Because there is friction to see what should be frictionless, it isn’t part of routine.  

### Once the secret was obtained, why was access not immediately restored? 
Line manager had indicated that change request governance processes would need to be followed to instate the new secret and restore access. Access was restored soon after the next CAB meeting occurred as permission was obtained during that meeting.  

## Wonderings

Why are B2B guest accounts added as app registration owners if they cannot exercise a primary privilege of app registration ownership? 

Monitoring to detect the outage was ignored, it was only spotted when trying to access the service during working hours.

There was clear and regular communication internally about the outage and progress to address it, and although initially stilted, eventually clear and regular communication with line manager (client side) on the matter. 

## Resolutions

We want to explore adding all the secrets to our own system register; particularly to ensure that there is alway access over leave periods etc. 

We are working to get access to identify all app registrations and enterprise applications, as well as identify owners, and add owners where we do not have two people within our organisation who are registered as owners. 

Add reminders for secret expiry. 

Consider renewing secrets ahead of expiry to improve risk mitigation thereof. 

Calendar reminder has already been added for the secret that expired. 